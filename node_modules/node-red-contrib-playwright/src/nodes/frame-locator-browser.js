module.exports = function (RED) {
	function NodeFrameLocatorBrowser(conf) {
		RED.nodes.createNode(this, conf)

		let node = this

		node.on('input', async (message, send, done) => {
			// Cheat to allow correct typing in typescript
			const msg = message

			if (!msg.context || !msg.browser) {
				node.error('Browser instance not found!')
				node.status({ fill: 'yellow', shape: 'dot', text: 'instance not found' })
				done()
			}

			if (!msg.frame) {
				node.error('Frame instance not found!')
				node.status({ fill: 'yellow', shape: 'dot', text: 'instance not found' })
				done()
			}

			try {
				msg.frameLocator = msg.frame.locator(conf.selector)

				node.status({ fill: 'green', shape: 'dot', text: 'success' })

				send(msg)
				done()
			} catch (e) {
				msg.browser = null
				msg.context = null
				node.error('Error create frame locator browser!')
				node.status({ fill: 'red', shape: 'ring', text: 'create frame locator error' })
				done(e)
			}
		})
	}

	RED.nodes.registerType('frame-locator-browser', NodeFrameLocatorBrowser)
}
